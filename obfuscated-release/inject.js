(()=>{console.log('[Doubao Tool] 注入脚本已加载');let originalFetch=window.fetch,originalXHR=(window.fetch=function(...o){var[e,l]=o;return console.log('[Doubao Tool] Fetch拦截到请求:',e),e.includes('/im/chain/single')&&l&&'POST'===l.method?(console.log('[Doubao Tool] Fetch检测到豆包图片API请求，开始处理响应'),originalFetch.apply(this,o).then(o=>(console.log('[Doubao Tool] Fetch豆包API响应状态:',o.status),o.clone().json().then(o=>{console.log('[Doubao Tool] Fetch豆包API响应数据:',o),t(o)}).catch(o=>{console.error('[Doubao Tool] Fetch解析豆包API响应JSON时出错:',o)}),o))):originalFetch.apply(this,o)},window.XMLHttpRequest);function t(o){try{var e,l,n,t,a=o.downlink_body?.pull_singe_chain_downlink_body?.messages;if(console.log('[Doubao Tool] 提取的消息数量:',a?a.length:0),a&&0<a.length)for(var s of a)console.log('[Doubao Tool] 处理消息:',{user_type:s.user_type,content_type:s.content_type}),2===s.user_type&&9999===s.content_type&&(console.log('[Doubao Tool] 解析内容块数量:',(e=JSON.parse(s.content)).length),(l=e.find(o=>2074===o.block_type&&o.content.creation_block))?(console.log('[Doubao Tool] 找到图片块'),console.log('[Doubao Tool] 图片创建项数量:',(n=l.content.creation_block.creations)?n.length:0),n&&(console.log('[Doubao Tool] 提取的图片数量:',(t=n.filter(o=>1===o.type&&o.image).map(o=>{var e=o.image;return{id:o.image.key,prompt:e.gen_params.prompt,rawUrl:e.image_ori_raw?.url,thumbUrl:e.image_thumb?.url}})).length),console.log('[Doubao Tool] 提取的图片数据:',t),0<t.length?(console.log('[Doubao Tool] 触发doubaoImagesFound事件'),window.dispatchEvent(new CustomEvent('doubaoImagesFound',{detail:{images:t}}))):console.log('[Doubao Tool] 没有找到有效的图片'))):console.log('[Doubao Tool] 没有找到图片块'));else console.log('[Doubao Tool] 响应中没有消息或消息为空')}catch(o){console.error('[Doubao Tool] 处理豆包API响应时出错:',o)}}window.XMLHttpRequest=function(){let e=new originalXHR,n=e.open,l=e.send;return e.open=function(o,e,...l){return console.log('[Doubao Tool] XHR拦截到请求:',o,this._url=e),n.call(this,o,e,...l)},e.send=function(o){return e.addEventListener('load',()=>{if(this._url&&this._url.includes('/im/chain/single')){console.log('[Doubao Tool] XHR检测到豆包图片API响应');try{var o=JSON.parse(this.responseText);console.log('[Doubao Tool] XHR豆包API响应数据:',o),t(o)}catch(o){console.error('[Doubao Tool] XHR解析豆包API响应JSON时出错:',o)}}}),l.apply(this,arguments)},e}})();